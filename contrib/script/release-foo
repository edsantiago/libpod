#!/bin/sh

ME=$(basename $0)

set -ex

#RN=/home/esm/src/atomic/2018-02.podman/cri-o/build/bin/release-notes
RN=/home/esm/go/bin/release-notes

# FIXME
#WANT=v4.1
WANT=${1?Usage: $ME TAG, where TAG is e.g. v4.1}

# Pull and make sure repo is up-to-date
git fetch upstream
git checkout $WANT
git pull

# Most recent release
start_tag=$(git describe --tags --abbrev=0)
end_sha=$(git rev-parse HEAD)

# Write template file
template=$(mktemp --tmpdir $ME.tmp.XXXXXXX)
cat >| $template <<EOF
# Podman $WANT

The release notes have been generated for the commit range
[${start_tag}...${end_sha}](https://github.com/containers/podman/compare/${start_tag}...${end_sha}) on $(date).

# Changelog since $start_tag

{{with .NotesWithActionRequired -}}
## Urgent Upgrade Notes

{{range .}} {{println "-" .}} {{end}}
{{end}}

{{- if .Notes -}}
## Changes by Kind
{{ range .Notes}}
### {{.Kind | prettyKind}}
{{range \$note := .NoteEntries }}{{println " -" \$note}}{{end}}
{{- end -}}
{{- end -}}
EOF


$RN --org=containers --repo=podman \
    --branch=$WANT \
    --repo-path=/var/tmp/pmpm$$ \
    --required-author= \
    --start-rev=$start_tag \
    --end-sha=$end_sha \
    --output=/tmp/esm-esm.md \
    --toc \
    --markdown-links \
    --go-template=go-template:$template

rm -f $template

git checkout podman-release-notes
mv /tmp/esm-esm.md $WANT.md
git add $WANT.md
git commit -m"release notes for $WANT" $WANT.md

# --required-author= --start-rev=v1.22.0 --end-sha=7e218a36eb7c48c6d0f5de65523e238b04f2b313 --output=/home/esm/src/atomic/2017-09.cri-o/cri-o/build/release-notes/v1.23.0.md --toc --go-template=go-template:/dev/shm/258053125
